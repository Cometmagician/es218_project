---
title: "ES218 Project: US Vehicular Accidents"
author: "Curtis Zhuang"
date: "5/4/2020"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message = FALSE)
```


```{r Install pacakges}
# Install packages
library(stringr)
library(tidyr)
library(tidyr)
library(ggplot2)
library(dplyr)
library(tmap) 
#library(spData)
#library(spDataLarge)
library(sf)

#install.packages('spDataLarge', repos='https://nowosad.github.io/drat/', type='source')
```


```{r Load data and first manipulation}
# Want to test if sex, car type, 
dat <- readRDS('../Data/farsp.RDS')

# group the states into four main regions in U.S

# Regroup and create region variable
west <- c(2,4,6,8,15,16,32,35,41,49,53,56 )
midwe <- c(17,18,10,20,26,27,30,31,38,39,46)
south <- c(1,5,11,12,13,21,22,24,28,29,37,40,45,47,48,51,54)
northea <- c(9,10,23,25,33,34,36,42,44,50,55 )
oth <- c(43,52)

# Regroup car type

dat <- dat %>% 
  mutate('Region' = case_when(state  %in% west ~ 'West',
                              state %in% midwe ~ 'MidWest',
                              state  %in% south ~ 'South',
                              state  %in% northea ~ 'NorthEast',
                              state  %in% oth ~ 'Other'))

dat_full <- dat %>% 
  select(-c(day, hour, minute, county)) %>% 
  # filter out severity
  filter(inj_sev %in% c(1,2,3,4,5,6))%>% 
  # filter out Virgin Islands and Puerto Rico
  drop_na(Region)
```


### Introduction

This study is conducted in light of the dataset recorded by the NHTSA for the years 1996 through 2016 on vehicular accidents. This is a large dataset as it contain many dimensions of an accident from the time the accident happens, the age of the driver caught in the accident, the location the accident takes place, type of the vehicle, etc. However, for this study, I only choose part of the variables as I am my interest lies in: 

1. Are there regional differences that between the traffic accidents?
2. Is the severity of the accidents affected by some of the variables that are included in this dataset?

In order to study the first question, I grouped the states into four main categories: West, MidWest, NorthEast and South (which is the most common way of grouping states). From there I created graphs to compare some of the selected variables between the four groups.

To study the second question, I used bivariate models to analyze if the severity of the accidents are related to the variables of my choice, namely: age, region, sex, collision type and people involved in the accident. From my study, I find that all the variables I choose are significant when it comes to severity.

The paper is structured as followed: the Methods section will touch briefly on what kind of graphs I made and what models I used; the Reults section will focus on explaining the results shown by the graphs as well as interpreting the results from the models; the Discussion section will dig deeper into the findings of the results seciton.

\newline

### Methods

As discussed above, I followed the most common way of grouping states and come out with four groups. I excluded Puerto Rico and Virgin Island due to the scarcity of samples they have compared with other groups and their nature of being small islands which may cause issues. The original dataset has 1906184 entries. 

I performed piping operations and removed the samples from Puerto Rican and Virgin Island after I finished grouping. Another group that I discarded in this study is the data entries reported as "Unknown"/"Not reported" which can be found for both the sex variable and the collision type variable. In total, they do not account for a large number and getting rid of these variables can help reduce the chance of having outliers. There are 1467635 samples left after these operations.

To study how the vehicular accidents can be affected by the location it takes place, I used univariate methods for some of the category variables and used bivariate methods for the quantative variables.

After looking the graphs, I created two models. The first model has severity as dependent variable,  region and age as independent variable. This models captures mainly how regio can affect severity of the accident when age is controlled. The next model expands the scope of variables and studies more generally what variables can affect severity.

\newline

### Results
The results section looks at each variable following the order of: Region, Sex, Collision, Age, Number of ppl involved, and Severity. 

\newline

#### Here I wan to Inclue a Map (Region)
#### Region
```{r Accidents breakdown by four main regions}
# Region by year
dat_reg <- dat_full %>%
  group_by(year, Region) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  group_by(year) %>% 
  mutate(percent = n/sum(n))%>% 
  drop_na(Region)

ggplot(dat_reg, aes(year, percent, fill = Region)) + 
  geom_bar(position = 'stack', stat = 'identity') +
  xlab('Year') + ylab('Percentage of Accidents') + 
  ggtitle('Accidents breakdown by Region') +
  theme(
    plot.title = element_text(color="black", size=14, face="bold.italic"),
    axis.title.x = element_text(color="black", size=14, face="bold"),
    axis.title.y = element_text(color="black", size=14, face="bold"))
```

Based on the barchart showing distribution of accidents across the four regions, we can observe that the percentage of accidents for each state did not fluctuate a lot over the course of the 22 years. Comapring the four regions, we see that the South has the most accidents which accounted for nearly 50%. 

This makes intuitive sense as geographically, we can see that the South covers lots of lands and includes states like Texas, Maryland, Florida which are all populated states. The large portion of accidents happening in the south will affect a lot of the results we will get from the other graphs.

\newline

####Sex
```{r Studying variable sex, out.width='48%' }

# Make a graph of how accidents happen related to sex
# male vs female by year
dat_sex <- dat_full %>%
  group_by(year, sex) %>% 
  summarise(n = n()) %>% 
  filter(sex %in% c(1,2)) %>% 
  mutate(sex = ifelse(sex == 1, "Male", "Female")) %>% 
  ungroup() %>% 
  group_by(year) %>% 
  mutate(percent = n/sum(n))

# plot the accident by sex
ggplot(dat_sex, aes(year, percent, col = sex)) + geom_point() +
  xlab('Year') + ylab('Percentage of Accidents') + 
  ggtitle('Accidents breakdown by sex') +
  theme(
    plot.title = element_text(color="black", size=14, face="bold.italic"),
    axis.title.x = element_text(color="black", size=14, face="bold"),
    axis.title.y = element_text(color="black", size=14, face="bold"))

# male vs female by region
dat_sex_loc <- dat_full %>% 
  group_by(Region, sex) %>% 
  summarise(n = n()) %>% 
  filter(sex %in% c(1,2)) %>% 
  mutate(sex = ifelse(sex == 1, "Male", "Female")) %>% 
  ungroup() %>% 
  group_by(sex) %>% 
  mutate(percent = n/sum(n))

# univariate
ggplot(dat_sex_loc, aes(Region, percent, fill = sex)) + 
  geom_bar(position = 'dodge', stat = 'identity') +
  xlab('Region') + ylab('Percentage of Accidents') + 
  ggtitle('Accidents breakdown by Region and Sex') +
  theme(
    plot.title = element_text(color="black", size=14, face="bold.italic"),
    axis.title.x = element_text(color="black", size=14, face="bold"),
    axis.title.y = element_text(color="black", size=14, face="bold"))
```

Here we consider how sex of the driver can contribute to the occurence of vehicular accident. From the graph on the left, we again observes a very constant fluctuation over time. About 65% of the accidents are caused by male drivers and about 35% of the accidents are caused by female drivers. 

However, when we observe the graph on the right, we did divergence in sex when we neglect the time dimension and only studies region. So, I suppose that there is no divergence when it comes to the effect of sex of driver on the accident between the regions.

#### Collision
```{r Studying variable collision}
# collision by year

dat_col <- dat_full %>%
  group_by(year, man_coll) %>% 
  summarise(n = n()) %>% 
  mutate(Collision = case_when(man_coll == "0" ~ 'Not with motor',
                               man_coll == "1" ~ 'Front-Rear',
                               man_coll == "2" ~ 'Front-Front',
                               man_coll == "3" ~ 'Not shown on Table (Known type 1)',
                               man_coll == "4" ~ 'Not shown on Table (Known type 2)',
                               man_coll == "6" ~ 'Angle',
                               man_coll == "7" ~ 'Sideswipe (same direc)',
                               man_coll == "8" ~ 'Sideswipe (oppo)',
                               man_coll == "9" ~ 'Rear-Side',
                               man_coll == "10" ~ 'Rear-Rear',
                               TRUE ~ 'Other')) %>% 
  ungroup() %>% 
  group_by(year) %>% 
  filter(Collision != 'Other') %>% 
  mutate(percent = n/sum(n))

ggplot(dat_col, aes(year, percent, col = Collision)) + geom_point() +
  geom_line() + xlab('Year') + ylab('Percentage of Accidents') + 
  ggtitle('Accidents breakdown by Collision type') +
  theme(
    plot.title = element_text(color="black", size=14, face="bold.italic"),
    axis.title.x = element_text(color="black", size=14, face="bold"),
    axis.title.y = element_text(color="black", size=14, face="bold"))


# keep the Region variable
dat_col_reg <- dat_full %>%
  group_by(year, man_coll, Region) %>% 
  summarise(n = n()) %>% 
  mutate(Collision = case_when(man_coll == "0" ~ 'Not with motor',
                               man_coll == "1" ~ 'Front-Rear',
                               man_coll == "2" ~ 'Front-Front',
                               man_coll == "3" ~ 'Not shown on Table (Known type 1)',
                               man_coll == "4" ~ 'Not shown on Table (Known type 2)',
                               man_coll == "6" ~ 'Angle',
                               man_coll == "7" ~ 'Sideswipe (same direc)',
                               man_coll == "8" ~ 'Sideswipe (oppo)',
                               man_coll == "9" ~ 'Rear-Side',
                               man_coll == "10" ~ 'Rear-Rear',
                               TRUE ~ 'Other')) %>% 
  ungroup() %>% 
  group_by(year) %>% 
  filter(Collision != 'Other') %>% 
  mutate(percent = n/sum(n))

ggplot(dat_col_reg, aes(year, percent, col = Collision)) + 
  geom_point() + geom_line() + facet_wrap( ~ Region) +
  xlab('Year') + ylab('Percentage of Accidents') + 
  ggtitle('Accidents breakdown by Collision type') +
  theme(
    plot.title = element_text(color="black", size=14, face="bold.italic"),
    axis.title.x = element_text(color="black", size=14, face="bold"),
    axis.title.y = element_text(color="black", size=14, face="bold"))
```
The next variable that I considered in the study is the type of collision. The metadata for this variable is very incomplete as there is not explanation for type 3 and 4 which I think shall represent the collision between the front of one car and the side of the other and the collision between the front of one car and angle of anther. But without further support, we cannot dig deeper into these two categories. 

From the first graph, it is obvious that a majority of accidents happen between a vehicle and a non-vehicle (constantly over 40%). As time increases, we see that there are more and more accidents that happens at angle of the road (probably as a result of more roads).

When we break down the collision by state, we can pinpoint the shape of accidents in South is very identical to the overall accidents. As we have talked about previously, a large proportion of the accidents happens in the South and this makes a lot of sense here. For the other three regions, though we see accidents with Non-motor also appears to be them most frequent type, it does not diverge that much from other types of collision.

#### Age

```{r Age variable}

## AGE
dat_age <- dat_full %>%
  group_by(year, Region) %>% 
  summarise(avg = mean(age))%>% 
  drop_na(Region)

ggplot(dat_age, aes(year, avg, col = Region)) + geom_point() +
  geom_smooth(se = FALSE, method = 'loess') +
  xlab('Year') + ylab('Average age of accident drivers') + 
  ggtitle('Average age of accident drivers') +
  theme(
    plot.title = element_text(color="black", size=14, face="bold.italic"),
    axis.title.x = element_text(color="black", size=14, face="bold"),
    axis.title.y = element_text(color="black", size=14, face="bold"))
```
We then shifts our focus to numerical variables. The first of which is average of accident drivers.By using a loess graph, we find that, interestingly, as time goes on, the average age of accident drivers also increase. With both increased about 16 years, we can suggest that there is a certain group of people that is very likely to get involved in traffic accidents. This trend is also observed for the four regions respectively, with a slight divergence after year 2015.


##### Number of person involved per accident
```{r Number of ppl invovled}

# Number of person vs year
dat_per <- dat_full %>%
  group_by(year, Region) %>% 
  summarise(avg = mean(per_no))

ggplot(dat_per, aes(year, avg, col = Region)) + geom_point() +
  geom_smooth(se = FALSE, method = 'loess') +
  xlab('Year') + ylab('Average number of people involved in accident') + 
  ggtitle('Average number of people involved') +
  theme(
    plot.title = element_text(color="black", size=14, face="bold.italic"),
    axis.title.x = element_text(color="black", size=14, face="bold"),
    axis.title.y = element_text(color="black", size=14, face="bold"))



```
Contrary to the average age which shows a positive trend, we see a downturn of average number of people involved in accidents which is a exciting finding. However, when we look at the data at 2016, three regions(West, South, NorthEast) have very close results around 1.65 compared with the data at MidWest. This is somewhat conterintuitive as we generally think that states in the North may have more people involved in a traffic accident due to more extreme weather. And the results here shown by the loess graph is completely opposite.


##### Severity
```{r Severity of accidents}

# Number of person vs year
# severity by region
dat_sev <- dat_full %>% 
  group_by(year, Region) %>% 
  summarise(avg = mean(inj_sev)) %>% 
  drop_na(Region)

ggplot(dat_sev, aes(year, avg, col = Region)) + geom_point() +
  geom_smooth(se = FALSE, method = 'loess') +
  xlab('Year') + ylab('Average severity of accidents') + 
  ggtitle('Severity of accidents') +
  theme(
    plot.title = element_text(color="black", size=14, face="bold.italic"),
    axis.title.x = element_text(color="black", size=14, face="bold"),
    axis.title.y = element_text(color="black", size=14, face="bold"))

# digging deeper into state

state <- read.csv("../Data/state_code.csv") %>%
  rename(state = state_code)

# Create the names for states
dat_state <- left_join(dat, state, by = 'state')

dat_states <- dat_state %>% 
  group_by(state_name) %>% 
  summarise(avrg_sev = mean(inj_sev)) %>% 
  ungroup()

# create plot
ggplot(dat_states, aes(state_name)) + geom_bar() +
  xlab("State") + ylab("Average severity for each state") + coord_flip() + 
  theme(
    plot.title = element_text(color="black", size=14, face="bold.italic"),
    axis.title.x = element_text(color="black", size=14, face="bold"),
    axis.title.y = element_text(color="black", size=14, face="bold")) 
```
When it comes to severity, I treat the original categorical variable, which has 6 levels (after dropping unknowns), as a numeric variable. The reason that I think it still functions is because in the dataset, the severity of accident increases with the figure assigned to it. Thus, we can treat it as a quantitative variable without losing its original function. From our graph, we can observe a increase of severity for all Regions except NorthEast which shows a 'S' shape. But overall, the severity of NorthEast accidents also increase.

This is conflicting when we recall the previous result that number of people involved in the accidents decrease. Thus, to study the relationship between severity and the other variables, I will study it using linear models.

I also breakdown the severity into the state level 

#### Model

#### Model 1 with only age and region
```{r Model 1: with only age and region}
lm_sev_age <- lm(inj_sev ~ age * Region, dat = dat_full)
summary(lm_sev_age)
```

#### Model 2
``` {r Model 2: with other variables}
lm_all <- lm(inj_sev ~ age * Region + sex + man_coll + per_no, dat = dat_full)
summary(lm_all)
```







### Discussion
Overall, both the study on regional effect on traffic accident and the study on how other variables affect severity shows significant results.